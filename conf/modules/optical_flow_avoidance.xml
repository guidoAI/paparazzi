<!DOCTYPE module SYSTEM "module.dtd">

<module name="optical_flow_avoidance" dir="ctrl">
  <doc>
    <description>
      Optical flow avoidance.

      This module uses the method from the article below to gauge distance for obstacle avoidance.

      de Croon, G.C.H.E. (2016). Monocular distance estimation with optical flow maneuvers and efference copies: a stability-based strategy. Bioinspiration and Biomimetics, 11(1), 016004.
    </description>
    <define name="OFA_AGL_ID" value="ABI_BROADCAST" description="Sender id of the AGL (sonar) ABI message"/>
    <section name="OFL" prefix="OFA_">
      <define name="PGAIN" value="0.50" description="P gain on height error"/>
      <define name="IGAIN" value="0.10" description="I gain on summed height error"/>
      <define name="DGAIN" value="0.0" description="D gain on summed height error"/>
      <define name="VISION_METHOD" value="1" description="0 = fake vision, 1 = real vision"/>
      <define name="CONTROL_METHOD" value="2" description="0 = fixed gain control, 1 = adaptive gain control, 2 = exponential control, 3 = predictive control"/>
      <define name="COV_METHOD" value="0" description="0 = cov(uz, div), 1 = cov(div_past, div)"/>
      <define name="COV_WINDOW_SIZE" value="30" description="Number of time steps for window size for getting the covariance over time."/>
      <define name="COV_LANDING_LIMIT" value="2.2" description="Covariance where the vehicle engages final landing procedure."/>
      <define name="COV_SETPOINT" value="-0.0075" description="Target Covariance for adaptive gain increment."/>
      <define name="LP_CONST" value="0.75" description="Low pass filter constant for divergence input."/>
      <define name="ELC_OSCILLATE" value="true" description="Oscillate to find optimum gain before initiating landing."/>
    </section>
  </doc>
  <settings>
    <dl_settings>
      <dl_settings NAME="OpticalFlowAvoidance">
        <dl_setting var="of_avoidance_ctrl.nominal_thrust" min="0" step="0.001" max="1" module="ctrl/optical_flow_landing" shortname="nominal_thrust"/>
        <dl_setting var="of_avoidance_ctrl.lp_const" min="0.005" step="0.005" max="1" module="ctrl/optical_flow_landing" shortname="lp_factor" param="OFA_LP_CONST"/>
        <dl_setting var="of_avoidance_ctrl.flow_setpoint" min="-1" step="0.01" max="1" module="ctrl/optical_flow_landing" shortname="div sp"/>
        <dl_setting var="of_avoidance_ctrl.cov_set_point" min="-6" step="0.0001" max="6" module="ctrl/optical_flow_landing" shortname="cov_set_point" param="OFA_COV_SETPOINT"/>
        <dl_setting var="of_avoidance_ctrl.cov_limit" min="0" step="0.0001" max="6" module="ctrl/optical_flow_landing" shortname="cov_limit" param="OFA_COV_LANDING_LIMIT"/>
        <dl_setting var="of_avoidance_ctrl.pgain" min="0" step="0.001" max="6" module="ctrl/optical_flow_landing" shortname="pgain" param="OFA_PGAIN"/>
        <dl_setting var="of_avoidance_ctrl.igain" min="0" step="0.001" max="1" module="ctrl/optical_flow_landing" shortname="igain" param="OFA_IGAIN"/>
        <dl_setting var="of_avoidance_ctrl.dgain" min="0" step="0.1" max="6" module="ctrl/optical_flow_landing" shortname="dgain" param="OFA_DGAIN"/>
        <dl_setting var="of_avoidance_ctrl.CONTROL_METHOD" min="0" step="1" max="3" values="Fixed|Adaptive|Exp|Predictive" module="ctrl/optical_flow_landing" shortname="CONTROL_METHOD" param="OFA_CONTROL_METHOD"/>
        <dl_setting var="of_avoidance_ctrl.COV_METHOD" min="0" step="1" max="1" values="Flow-Thrust|Flow-Shift flow" module="ctrl/optical_flow_landing" shortname="COV_METHOD" param="OFA_COV_METHOD"/>
        <dl_setting var="of_avoidance_ctrl.delay_steps" min="0" step="1" max="60" module="ctrl/optical_flow_landing" shortname="delay_steps"/>
        <dl_setting var="of_avoidance_ctrl.pgain_adaptive" min="0" step="0.1" max="20.0" module="ctrl/optical_flow_landing" shortname="pgain_adaptive"/>
        <dl_setting var="of_avoidance_ctrl.igain_adaptive" min="0" step="0.01" max="1.0" module="ctrl/optical_flow_landing" shortname="igain_adaptive"/>
        <dl_setting var="of_avoidance_ctrl.dgain_adaptive" min="0" step="0.01" max="5.0" module="ctrl/optical_flow_landing" shortname="dgain_adaptive"/>
      </dl_settings>
    </dl_settings>
  </settings>

  <header>
    <file name="optical_flow_avoidance.h"/>
  </header>

  <makefile target="ap|nps">
    <file name="optical_flow_avoidance.c"/>
  </makefile>

</module>
